// Inizializzazione storage
let cronologia = JSON.parse(localStorage.getItem('cronologia')) || [];

// Aggiungi event listeners per calcolare dinamicamente i consumi
document.querySelectorAll('#apt1mese1, #apt1mese2').forEach(input => {
  input.addEventListener('input', () => aggiornaConsumoApt(1));
});

document.querySelectorAll('#apt2mese1, #apt2mese2').forEach(input => {
  input.addEventListener('input', () => aggiornaConsumoApt(2));
});

document.querySelectorAll('#apt3mese1, #apt3mese2').forEach(input => {
  input.addEventListener('input', () => aggiornaConsumoApt(3));
});

// Funzione per aggiornare il consumo di un appartamento
function aggiornaConsumoApt(apt) {
  const iniziale = parseFloat(document.getElementById(`apt${apt}mese1`).value) || 0;
  const finale = parseFloat(document.getElementById(`apt${apt}mese2`).value) || 0;
  const consumo = Math.max(0, finale - iniziale);
  document.getElementById(`consumoApt${apt}`).textContent = consumo;
}

// Funzione per calcolare i consumi di tutti gli appartamenti
function calcolaConsumi() {
  for (let apt = 1; apt <= 3; apt++) {
    aggiornaConsumoApt(apt);
  }
  
  // Passa automaticamente alla tab successiva
  const componentsTab = new bootstrap.Tab(document.getElementById('components-tab'));
  componentsTab.show();
}

// Funzione per verificare i componenti della bolletta
function verificaComponenti() {
  // Ottengo i valori dei componenti
  const spesaEnergia = parseFloat(document.getElementById('spesaEnergia').value) || 0;
  const scontoOfferta = parseFloat(document.getElementById('scontoOfferta').value) || 0;
  const spesaTrasporto = parseFloat(document.getElementById('spesaTrasporto').value) || 0;
  const oneriSistema = parseFloat(document.getElementById('oneriSistema').value) || 0;
  const altrePartite = parseFloat(document.getElementById('altrePartite').value) || 0;
  const imposte = parseFloat(document.getElementById('imposte').value) || 0;
  const iva = parseFloat(document.getElementById('iva').value) || 0;
  
  // Calcolo la somma dei componenti
  const sommaComponenti = spesaEnergia - scontoOfferta + spesaTrasporto + 
                          oneriSistema + altrePartite + imposte + iva;
  
  // Ottengo il totale della bolletta
  const totaleBolletta = parseFloat(document.getElementById('totaleBolletta').value) || 0;
  
  // Verifico se la somma dei componenti è uguale al totale della bolletta
  const differenza = Math.abs(sommaComponenti - totaleBolletta);
  const verificaTotale = document.getElementById('verificaTotale');
  const btnCalcola = document.getElementById('btnCalcola');
  
  if (differenza > 0.01 && totaleBolletta > 0) {
    verificaTotale.style.display = 'block';
    verificaTotale.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> 
                               Attenzione: La somma dei componenti (€ ${sommaComponenti.toFixed(2)}) 
                               non corrisponde al totale della bolletta (€ ${totaleBolletta.toFixed(2)}). 
                               Differenza: € ${differenza.toFixed(2)}`;
    btnCalcola.disabled = true;
  } else {
    verificaTotale.style.display = 'none';
    btnCalcola.disabled = false;
  }
}

// Funzione per calcolare la ripartizione
function calcola() {
  // Ottengo i consumi degli appartamenti
  const consumoApt1 = parseInt(document.getElementById('consumoApt1').textContent) || 0;
  const consumoApt2 = parseInt(document.getElementById('consumoApt2').textContent) || 0;
  const consumoApt3 = parseInt(document.getElementById('consumoApt3').textContent) || 0;
  
  // Calcolo il totale dei consumi
  const totaleConsumi = consumoApt1 + consumoApt2 + consumoApt3;
  
  // Verifico che ci siano consumi
  if (totaleConsumi === 0) {
    alert('Non sono stati rilevati consumi. Inserisci le letture dei contascatti.');
    return;
  }
  
  // Calcolo le percentuali di consumo
  const percentualeApt1 = (consumoApt1 / totaleConsumi) * 100;
  const percentualeApt2 = (consumoApt2 / totaleConsumi) * 100;
  const percentualeApt3 = (consumoApt3 / totaleConsumi) * 100;
  
  // Ottengo i componenti della bolletta
  const totaleBolletta = parseFloat(document.getElementById('totaleBolletta').value) || 0;
  const spesaEnergia = parseFloat(document.getElementById('spesaEnergia').value) || 0;
  const scontoOfferta = parseFloat(document.getElementById('scontoOfferta').value) || 0;
  const spesaTrasporto = parseFloat(document.getElementById('spesaTrasporto').value) || 0;
  const oneriSistema = parseFloat(document.getElementById('oneriSistema').value) || 0;
  const altrePartite = parseFloat(document.getElementById('altrePartite').value) || 0;
  const imposte = parseFloat(document.getElementById('imposte').value) || 0;
  const iva = parseFloat(document.getElementById('iva').value) || 0;
  
  // Calcolo l'importo per ciascun appartamento
  const pagareApt1 = totaleBolletta * (percentualeApt1 / 100);
  const pagareApt2 = totaleBolletta * (percentualeApt2 / 100);
  const pagareApt3 = totaleBolletta * (percentualeApt3 / 100);
  
  // Calcolo il dettaglio delle componenti per ogni appartamento
  const componenti = [
    { nome: 'Spesa Materia Energia', totale: spesaEnergia },
    { nome: 'Sconto Offerta', totale: -scontoOfferta },
    { nome: 'Spesa Trasporto', totale: spesaTrasporto },
    { nome: 'Oneri di Sistema', totale: oneriSistema },
    { nome: 'Altre Partite', totale: altrePartite },
    { nome: 'Imposte', totale: imposte },
    { nome: 'IVA', totale: iva }
  ];
  
  // Aggiorno il riepilogo dei risultati
  const dataInizio = document.getElementById('dataPeriodoInizio').value;
  const dataFine = document.getElementById('dataPeriodoFine').value;
  document.getElementById('periodoRiferimento').textContent = `Dal ${formatDate(dataInizio)} al ${formatDate(dataFine)}`;
  document.getElementById('totaleRiepilogo').textContent = `€ ${totaleBolletta.toFixed(2)}`;
  
  // Aggiorno i risultati per ogni appartamento
  document.getElementById('consumoApt1Risultato').textContent = consumoApt1;
  document.getElementById('percentualeApt1').textContent = `${percentualeApt1.toFixed(2)}%`;
  document.getElementById('pagareApt1').textContent = `€ ${pagareApt1.toFixed(2)}`;
  
  document.getElementById('consumoApt2Risultato').textContent = consumoApt2;
  document.getElementById('percentualeApt2').textContent = `${percentualeApt2.toFixed(2)}%`;
  document.getElementById('pagareApt2').textContent = `€ ${pagareApt2.toFixed(2)}`;
  
  document.getElementById('consumoApt3Risultato').textContent = consumoApt3;
  document.getElementById('percentualeApt3').textContent = `${percentualeApt3.toFixed(2)}%`;
  document.getElementById('pagareApt3').textContent = `€ ${pagareApt3.toFixed(2)}`;
  
  // Aggiorno la tabella del dettaglio componenti
  const dettaglioComponenti = document.getElementById('dettaglioComponenti');
  dettaglioComponenti.innerHTML = '';
  
  componenti.forEach(componente => {
    const componenteApt1 = componente.totale * (percentualeApt1 / 100);
    const componenteApt2 = componente.totale * (percentualeApt2 / 100);
    const componenteApt3 = componente.totale * (percentualeApt3 / 100);
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${componente.nome}</td>
      <td class="text-center">€ ${componente.totale.toFixed(2)}</td>
      <td class="text-center">€ ${componenteApt1.toFixed(2)}</td>
      <td class="text-center">€ ${componenteApt2.toFixed(2)}</td>
      <td class="text-center">€ ${componenteApt3.toFixed(2)}</td>
    `;
    
    dettaglioComponenti.appendChild(tr);
  });
  
  // Aggiorno i totali della tabella
  document.getElementById('totaleComplessivo').textContent = `€ ${totaleBolletta.toFixed(2)}`;
  document.getElementById('totaleApt1').textContent = `€ ${pagareApt1.toFixed(2)}`;
  document.getElementById('totaleApt2').textContent = `€ ${pagareApt2.toFixed(2)}`;
  document.getElementById('totaleApt3').textContent = `€ ${pagareApt3.toFixed(2)}`;
  
  // Mostro i risultati
  document.getElementById('noResults').style.display = 'none';
  document.getElementById('risultatoContainer').style.display = 'block';
  
  // Passo alla tab dei risultati
  const resultsTab = new bootstrap.Tab(document.getElementById('results-tab'));
  resultsTab.show();
  
  // Salvo nella cronologia
  salvaInCronologia({
    data: new Date().toISOString(),
    periodo: `${formatDate(dataInizio)} - ${formatDate(dataFine)}`,
    totale: totaleBolletta,
    apt1: pagareApt1,
    apt2: pagareApt2,
    apt3: pagareApt3,
    dettaglio: {
      consumo: {
        apt1: consumoApt1,
        apt2: consumoApt2,
        apt3: consumoApt3
      },
      percentuali: {
        apt1: percentualeApt1,
        apt2: percentualeApt2,
        apt3: percentualeApt3
      },
      componenti: componenti
    }
  });
}

// Funzione per salvare nella cronologia
function salvaInCronologia(ripartizione) {
  cronologia.unshift(ripartizione); // Aggiungi all'inizio dell'array
  localStorage.setItem('cronologia', JSON.stringify(cronologia));
  aggiornaCronologiaUI();
}

// Funzione per aggiornare la UI della cronologia
function aggiornaCronologiaUI() {
  const cronologiaBody = document.getElementById('cronologiaBody');
  const noCronologia = document.getElementById('noCronologia');
  const cronologiaContainer = document.getElementById('cronologiaContainer');
  
  if (cronologia.length === 0) {
    noCronologia.style.display = 'block';
    cronologiaContainer.style.display = 'none';
    return;
  }
  
  noCronologia.style.display = 'none';
  cronologiaContainer.style.display = 'block';
  
  cronologiaBody.innerHTML = '';
  
  cronologia.forEach((item, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${formatDate(item.data)}</td>
      <td>${item.periodo}</td>
      <td class="text-center">€ ${item.totale.toFixed(2)}</td>
      <td class="text-center">€ ${item.apt1.toFixed(2)}</td>
      <td class="text-center">€ ${item.apt2.toFixed(2)}</td>
      <td class="text-center">€ ${item.apt3.toFixed(2)}</td>
      <td class="text-center">
        <button class="btn btn-sm btn-info me-2" onclick="visualizzaDettaglio(${index})">
          <i class="fas fa-eye"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="rimuoviDaCronologia(${index})">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    
    cronologiaBody.appendChild(tr);
  });
}

// Funzione per visualizzare il dettaglio di una ripartizione dalla cronologia
function visualizzaDettaglio(index) {
  const item = cronologia[index];
  
  // Ripopolo i risultati con i dati della cronologia
  document.getElementById('consumoApt1Risultato').textContent = item.dettaglio.consumo.apt1;
  document.getElementById('percentualeApt1').textContent = `${item.dettaglio.percentuali.apt1.toFixed(2)}%`;
  document.getElementById('pagareApt1').textContent = `€ ${item.apt1.toFixed(2)}`;
  
  document.getElementById('consumoApt2Risultato').textContent = item.dettaglio.consumo.apt2;
  document.getElementById('percentualeApt2').textContent = `${item.dettaglio.percentuali.apt2.toFixed(2)}%`;
  document.getElementById('pagareApt2').textContent = `€ ${item.apt2.toFixed(2)}`;
  
  document.getElementById('consumoApt3Risultato').textContent = item.dettaglio.consumo.apt3;
  document.getElementById('percentualeApt3').textContent = `${item.dettaglio.percentuali.apt3.toFixed(2)}%`;
  document.getElementById('pagareApt3').textContent = `€ ${item.apt3.toFixed(2)}`;
  
  document.getElementById('periodoRiferimento').textContent = item.periodo;
  document.getElementById('totaleRiepilogo').textContent = `€ ${item.totale.toFixed(2)}`;
  
  // Aggiorno la tabella delle componenti
  const dettaglioComponenti = document.getElementById('dettaglioComponenti');
  dettaglioComponenti.innerHTML = '';
  
  item.dettaglio.componenti.forEach(componente => {
    const componenteApt1 = componente.totale * (item.dettaglio.percentuali.apt1 / 100);
    const componenteApt2 = componente.totale * (item.dettaglio.percentuali.apt2 / 100);
    const componenteApt3 = componente.totale * (item.dettaglio.percentuali.apt3 / 100);
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${componente.nome}</td>
      <td class="text-center">€ ${componente.totale.toFixed(2)}</td>
      <td class="text-center">€ ${componenteApt1.toFixed(2)}</td>
      <td class="text-center">€ ${componenteApt2.toFixed(2)}</td>
      <td class="text-center">€ ${componenteApt3.toFixed(2)}</td>
    `;
    
    dettaglioComponenti.appendChild(tr);
  });
  
  // Aggiorno i totali
  document.getElementById('totaleComplessivo').textContent = `€ ${item.totale.toFixed(2)}`;
  document.getElementById('totaleApt1').textContent = `€ ${item.apt1.toFixed(2)}`;
  document.getElementById('totaleApt2').textContent = `€ ${item.apt2.toFixed(2)}`;
  document.getElementById('totaleApt3').textContent = `€ ${item.apt3.toFixed(2)}`;
  
  // Mostro i risultati
  document.getElementById('noResults').style.display = 'none';
  document.getElementById('risultatoContainer').style.display = 'block';
  
  // Passo alla tab dei risultati
  const resultsTab = new bootstrap.Tab(document.getElementById('results-tab'));
  resultsTab.show();
}

// Funzione per rimuovere dalla cronologia
function rimuoviDaCronologia(index) {
  if (confirm('Sei sicuro di voler rimuovere questa ripartizione dalla cronologia?')) {
    cronologia.splice(index, 1);
    localStorage.setItem('cronologia', JSON.stringify(cronologia));
    aggiornaCronologiaUI();
  }
}

// Funzione per svuotare la cronologia
function svuotaCronologia() {
  if (confirm('Sei sicuro di voler eliminare tutta la cronologia? Questa azione non può essere annullata.')) {
    cronologia = [];
    localStorage.setItem('cronologia', JSON.stringify(cronologia));
    aggiornaCronologiaUI();
  }
}

// Funzione per stampare i risultati
function stampaRisultati() {
  window.print();
}

// Funzione ausiliaria per formattare le date
function formatDate(dateString) {
  if (!dateString) return '-';
  
  // Se è in formato ISO
  if (dateString.includes('T')) {
    const date = new Date(dateString);
    return date.toLocaleDateString('it-IT');
  }
  
  // Se è già in formato YYYY-MM-DD
  const parts = dateString.split('-');
  if (parts.length === 3) {
    return `${parts[2]}/${parts[1]}/${parts[0]}`;
  }
  
  return dateString;
}

// Inizializzo la UI della cronologia all'avvio
document.addEventListener('DOMContentLoaded', () => {
  aggiornaCronologiaUI();
});
