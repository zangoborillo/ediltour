<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Bollette Condominio</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .card {
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      border-radius: 12px;
      border: none;
    }
    .header-card {
      background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
      color: white;
      border-radius: 10px 10px 0 0;
      padding: 20px;
    }
    .nav-tabs .nav-link {
      border: none;
      color: #495057;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 0;
      transition: all 0.3s;
    }
    .nav-tabs .nav-link.active {
      background-color: #fff;
      color: #4b6cb7;
      border-bottom: 3px solid #4b6cb7;
    }
    .tab-content {
      padding: 25px;
      background-color: #fff;
      border-radius: 0 0 10px 10px;
    }
    .input-group-text {
      background-color: #4b6cb7;
      color: white;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
      border: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 10px 20px;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }
    .list-group-item {
      border-left: none;
      border-right: none;
      padding: 12px 20px;
    }
    .list-group-item:first-child {
      border-top: none;
    }
    .badge {
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 20px;
    }
    .form-control {
      border-radius: 8px;
      padding: 12px 15px;
      border: 1px solid #ced4da;
    }
    .form-control:focus {
      box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.25);
      border-color: #4b6cb7;
    }
    .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
    }
    .alert {
      border-radius: 10px;
      padding: 15px 20px;
    }
    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #4b6cb7;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .result-card {
      background-color: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
    }
    .expense-item {
      transition: all 0.3s;
    }
    .expense-item:hover {
      background-color: #f8f9fa;
    }
    .delete-btn {
      color: #dc3545;
      cursor: pointer;
      transition: all 0.2s;
    }
    .delete-btn:hover {
      transform: scale(1.2);
    }
    .component-value {
      border-left: 3px solid #4b6cb7;
      padding-left: 15px;
    }
    .date-badge {
      background-color: #e9ecef;
      color: #495057;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
    }
    @media (max-width: 768px) {
      .row {
        margin-bottom: 0 !important;
      }
      .col-md-6, .col-md-4 {
        margin-bottom: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="card mb-4">
      <div class="header-card mb-0">
        <h2 class="text-center mb-0">
          <i class="fas fa-bolt me-2"></i> Sistema di Gestione Bollette Condominio
        </h2>
      </div>
      
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="input-tab" data-bs-toggle="tab" data-bs-target="#input-tab-pane" type="button" role="tab">
            <i class="fas fa-pen-to-square me-2"></i>Inserimento Dati
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="components-tab" data-bs-toggle="tab" data-bs-target="#components-tab-pane" type="button" role="tab">
            <i class="fas fa-file-invoice-dollar me-2"></i>Componenti Bolletta
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results-tab-pane" type="button" role="tab">
            <i class="fas fa-chart-pie me-2"></i>Risultati
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-tab-pane" type="button" role="tab">
            <i class="fas fa-history me-2"></i>Cronologia
          </button>
        </li>
      </ul>
      
      <div class="tab-content" id="myTabContent">
        <!-- Tab Inserimento Dati -->
        <div class="tab-pane fade show active" id="input-tab-pane" role="tabpanel" tabindex="0">
          <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle me-2"></i> Inserisci le letture dei contascatti per ogni appartamento all'inizio e alla fine del periodo.
          </div>
          
          <h5 class="mb-4 border-bottom pb-2">
            <i class="fas fa-calendar-alt me-2"></i> Periodo di riferimento
          </h5>
          
          <div class="row mb-4">
            <div class="col-md-6">
              <label for="dataPeriodoInizio" class="form-label">Data inizio periodo</label>
              <input type="date" class="form-control" id="dataPeriodoInizio">
            </div>
            <div class="col-md-6">
              <label for="dataPeriodoFine" class="form-label">Data fine periodo</label>
              <input type="date" class="form-control" id="dataPeriodoFine">
            </div>
          </div>
          
          <h5 class="mb-4 mt-4 border-bottom pb-2">
            <i class="fas fa-tachometer-alt me-2"></i> Letture Contascatti
          </h5>
          
          <div class="row mb-4">
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-header bg-primary text-white">
                  <i class="fas fa-home me-2"></i> Appartamento 1
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label for="apt1mese1" class="form-label">Lettura Iniziale</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-play"></i></span>
                      <input type="number" class="form-control" id="apt1mese1" placeholder="0">
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="apt1mese2" class="form-label">Lettura Finale</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-flag-checkered"></i></span>
                      <input type="number" class="form-control" id="apt1mese2" placeholder="0">
                    </div>
                  </div>
                  <div class="mt-3 bg-light p-2 rounded">
                    Consumo: <span id="consumoApt1">0</span> scatti
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-header bg-success text-white">
                  <i class="fas fa-home me-2"></i> Appartamento 2
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label for="apt2mese1" class="form-label">Lettura Iniziale</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-play"></i></span>
                      <input type="number" class="form-control" id="apt2mese1" placeholder="0">
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="apt2mese2" class="form-label">Lettura Finale</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-flag-checkered"></i></span>
                      <input type="number" class="form-control" id="apt2mese2" placeholder="0">
                    </div>
                  </div>
                  <div class="mt-3 bg-light p-2 rounded">
                    Consumo: <span id="consumoApt2">0</span> scatti
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-header bg-info text-white">
                  <i class="fas fa-home me-2"></i> Appartamento 3
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label for="apt3mese1" class="form-label">Lettura Iniziale</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-play"></i></span>
                      <input type="number" class="form-control" id="apt3mese1" placeholder="0">
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="apt3mese2" class="form-label">Lettura Finale</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-flag-checkered"></i></span>
                      <input type="number" class="form-control" id="apt3mese2" placeholder="0">
                    </div>
                  </div>
                  <div class="mt-3 bg-light p-2 rounded">
                    Consumo: <span id="consumoApt3">0</span> scatti
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button class="btn btn-primary" id="btnCalcolaConsumi">
              <i class="fas fa-calculator me-2"></i> Calcola Consumi
            </button>
          </div>
        </div>
        
        <!-- Tab Componenti Bolletta -->
        <div class="tab-pane fade" id="components-tab-pane" role="tabpanel" tabindex="0">
          <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle me-2"></i> Inserisci tutte le componenti della bolletta per una ripartizione dettagliata.
          </div>
          
          <h5 class="mb-4 border-bottom pb-2">
            <i class="fas fa-file-invoice me-2"></i> Dettaglio Componenti Bolletta
          </h5>
          
          <div class="row mb-4">
            <div class="col-md-6">
              <label for="kwhTotali" class="form-label">KWh Totali Consumati</label>
              <div class="input-group mb-3">
                <span class="input-group-text"><i class="fas fa-bolt"></i></span>
                <input type="number" class="form-control" id="kwhTotali" placeholder="0" step="0.01">
                <span class="input-group-text">kWh</span>
              </div>
            </div>
            
            <div class="col-md-6">
              <label for="totaleBolletta" class="form-label">Importo Totale Bolletta</label>
              <div class="input-group mb-3">
                <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                <input type="number" class="form-control" id="totaleBolletta" placeholder="0.00" step="0.01">
              </div>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="spesaEnergia" class="form-label">Spesa per la Materia Energia</label>
              <div class="input-group mb-3">
                <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                <input type="number" class="form-control" id="spesaEnergia" placeholder="0.00" step="0.01">
              </div>
            </div>
            
            <div class="col-md-6">
              <label for="scontoOfferta" class="form-label">Sconto Offerta (se previsto)</label>
              <div class="input-group mb-3">
                <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                <input type="number" class="form-control" id="scontoOfferta" placeholder="0.00" step="0.01">
              </div>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="spesaTrasporto" class="form-label">Spesa per il Trasporto</label>
              <div class="input-group mb-3">
                <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                <input type="number" class="form-control" id="spesaTrasporto" placeholder="0.00" step="0.01">
              </div>
            </div>
            
            <div class="col-md-6">
              <label for="oneriSistema" class="form-label">Spesa per Oneri di Sistema</label>
              <div class="input-group mb-3">
                <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                <input type="number" class="form-control" id="oneriSistema" placeholder="0.00" step="0.01">
              </div>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="altrePartite" class="form-label">Altre Partite</label>
              <div class="input-group mb-3">
                <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                <input type="number" class="form-control" id="altrePartite" placeholder="0.00" step="0.01">
              </div>
            </div>
            
            <div class="col-md-4">
              <label for="imposte" class="form-label">Imposte</label>
              <div class="input-group mb-3">
                <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                <input type="number" class="form-control" id="imposte" placeholder="0.00" step="0.01">
              </div>
            </div>
            
            <div class="col-md-4">
              <label for="iva" class="form-label">IVA</label>
              <div class="input-group mb-3">
                <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                <input type="number" class="form-control" id="iva" placeholder="0.00" step="0.01">
              </div>
            </div>
          </div>
          
          <div class="alert alert-warning mt-4" id="verificaTotale" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i> Attenzione: La somma delle componenti non corrisponde al totale della bolletta.
          </div>
          
          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button class="btn btn-primary" id="btnVerificaComponenti">
              <i class="fas fa-check-double me-2"></i> Verifica Componenti
            </button>
            <button class="btn btn-success" id="btnCalcola" disabled>
              <i class="fas fa-calculator me-2"></i> Calcola Ripartizione
            </button>
          </div>
        </div>
        
        <!-- Tab Risultati -->
        <div class="tab-pane fade" id="results-tab-pane" role="tabpanel" tabindex="0">
          <div class="alert alert-warning" id="noResults" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i> Nessun risultato disponibile. Calcola prima una ripartizione.
          </div>
          
          <div id="risultatoContainer" style="display: none;">
            <h5 class="mb-4 border-bottom pb-2">
              <i class="fas fa-chart-bar me-2"></i> Riepilogo Consumi
            </h5>
            
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-header bg-primary text-white">
                    Periodo di Riferimento
                  </div>
                  <div class="card-body">
                    <p class="card-text" id="periodoRiferimento">-</p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-header bg-success text-white">
                    Totale Bolletta
                  </div>
                  <div class="card-body">
                    <h3 class="card-text" id="totaleRiepilogo">€ 0.00</h3>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="row mb-4">
              <div class="col-md-4">
                <div class="card text-center mb-3 border-primary">
                  <div class="card-header bg-primary text-white">
                    Appartamento 1
                  </div>
                  <div class="card-body">
                    <div class="mb-2">Consumo</div>
                    <h4 id="consumoApt1Risultato">0</h4>
                    <div class="badge bg-primary mb-2" id="percentualeApt1">0%</div>
                    <hr>
                    <div class="mb-2">Da Pagare</div>
                    <h3 id="pagareApt1">€ 0.00</h3>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card text-center mb-3 border-success">
                  <div class="card-header bg-success text-white">
                    Appartamento 2
                  </div>
                  <div class="card-body">
                    <div class="mb-2">Consumo</div>
                    <h4 id="consumoApt2Risultato">0</h4>
                    <div class="badge bg-success mb-2" id="percentualeApt2">0%</div>
                    <hr>
                    <div class="mb-2">Da Pagare</div>
                    <h3 id="pagareApt2">€ 0.00</h3>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card text-center mb-3 border-info">
                  <div class="card-header bg-info text-white">
                    Appartamento 3
                  </div>
                  <div class="card-body">
                    <div class="mb-2">Consumo</div>
                    <h4 id="consumoApt3Risultato">0</h4>
                    <div class="badge bg-info mb-2" id="percentualeApt3">0%</div>
                    <hr>
                    <div class="mb-2">Da Pagare</div>
                    <h3 id="pagareApt3">€ 0.00</h3>
                  </div>
                </div>
              </div>
            </div>
            
            <h5 class="mb-4 mt-5 border-bottom pb-2">
              <i class="fas fa-table me-2"></i> Dettaglio Ripartizione Componenti
            </h5>
            
            <div class="table-responsive">
              <table class="table table-hover table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Componente</th>
                    <th class="text-center">Totale</th>
                    <th class="text-center">Appartamento 1</th>
                    <th class="text-center">Appartamento 2</th>
                    <th class="text-center">Appartamento 3</th>
                  </tr>
                </thead>
                <tbody id="dettaglioComponenti">
                  <!-- Riempito via JavaScript -->
                </tbody>
                <tfoot class="table-light">
                  <tr>
                    <th>TOTALE</th>
                    <th class="text-center" id="totaleComplessivo">€ 0.00</th>
                    <th class="text-center" id="totaleApt1">€ 0.00</th>
                    <th class="text-center" id="totaleApt2">€ 0.00</th>
                    <th class="text-center" id="totaleApt3">€ 0.00</th>
                  </tr>
                </tfoot>
              </table>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
              <button class="btn btn-primary" id="btnStampaRisultati">
                <i class="fas fa-print me-2"></i> Stampa Risultati
              </button>
            </div>
          </div>
        </div>
        
        <!-- Tab Cronologia -->
        <div class="tab-pane fade" id="history-tab-pane" role="tabpanel" tabindex="0">
          <div id="noCronologia" class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i> Nessuna ripartizione nella cronologia.
          </div>
          
          <div id="cronologiaContainer">
            <h5 class="mb-3 border-bottom pb-2">
              <i class="fas fa-history me-2"></i> Cronologia Ripartizioni
            </h5>
            
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Data</th>
                    <th>Periodo</th>
                    <th class="text-center">Totale</th>
                    <th class="text-center">App. 1</th>
                    <th class="text-center">App. 2</th>
                    <th class="text-center">App. 3</th>
                    <th class="text-center">Azioni</th>
                  </tr>
                </thead>
                <tbody id="cronologiaBody">
                  <!-- Riempito via JavaScript -->
                </tbody>
              </table>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
              <button class="btn btn-danger" id="btnSvuotaCronologia">
                <i class="fas fa-trash me-2"></i> Svuota Cronologia
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Inizializzazione storage
    let cronologia = JSON.parse(localStorage.getItem('cronologia')) || [];
    
    // Variabili per memorizzare i dati dei consumi
    let consumoApt1 = 0;
    let consumoApt2 = 0;
    let consumoApt3 = 0;
    let consumoTotale = 0;
    
    // Funzione per formattare importi in Euro
    function formatEuro(amount) {
      return '€ ' + parseFloat(amount).toFixed(2);
    }
    
    // Funzione per formattare le date
    function formatDate(dateString) {
      if (!dateString) return "-";
      const date = new Date(dateString);
      return date.toLocaleDateString('it-IT');
    }
    
    // Aggiungi event listeners per calcolare dinamicamente i consumi
    document.querySelectorAll('#apt1mese1, #apt1mese2').forEach(input => {
      input.addEventListener('input', () => aggiornaConsumoApt(1));
    });
    
    document.querySelectorAll('#apt2mese1, #apt2mese2').forEach(input => {
      input.addEventListener('input', () => aggiornaConsumoApt(2));
    });
    
    document.querySelectorAll('#apt3mese1, #apt3mese2').forEach(input => {
      input.addEventListener('input', () => aggiornaConsumoApt(3));
    });
    
    // Funzione per aggiornare il consumo di un appartamento
    function aggiornaConsumoApt(apt) {
      const iniziale = parseFloat(document.getElementById(`apt${apt}mese1`).value) || 0;
      const finale = parseFloat(document.getElementById(`apt${apt}mese2`).value) || 0;
      const consumo = Math.max(0, finale - iniziale);
      document.getElementById(`consumoApt${apt}`).textContent = consumo;
      
      // Aggiorna le variabili globali
      if (apt === 1) consumoApt1 = consumo;
      if (apt === 2) consumoApt2 = consumo;
      if (apt === 3) consumoApt3 = consumo;
    }
    
    // Funzione per calcolare i consumi di tutti gli appartamenti
    function calcolaConsumi() {
      // Aggiorna tutti i consumi
      for (let apt = 1; apt <= 3; apt++) {
        aggiornaConsumoApt(apt);
      }
      
      // Calcola il totale
      consumoTotale = consumoApt1 + consumoApt2 + consumoApt3;
      
      // Verifica che ci siano consumi
      if (consumoTotale <= 0) {
        alert("Errore: il consumo totale è zero o negativo. Controlla le letture inserite.");
        return false;
      }
      
      // Passa alla tab successiva
      const componentsTab = document.getElementById('components-tab');
      bootstrap.Tab.getInstance(componentsTab) || new bootstrap.Tab(componentsTab);
      componentsTab.click();
      
      return true;
    }
    
    // Funzione per verificare i componenti della bolletta
    function verificaComponenti() {
      // Ottengo i valori dei componenti
      const spesaEnergia = parseFloat(document.getElementById('spesaEnergia').value) || 0;
      const scontoOfferta = parseFloat(document.getElementById('scontoOfferta').value) || 0;
      const spesaTrasporto = parseFloat(document.getElementById('spesaTrasporto').value) || 0;
      const oneriSistema = parseFloat(document.getElementById('oneriSistema').value) || 0;
      const altrePartite = parseFloat(document.getElementById('altrePartite').value) || 0;
      const imposte = parseFloat(document.getElementById('imposte').value) || 0;
      const iva = parseFloat(document.getElementById('iva').value) || 0;
      
      // Calcolo la somma dei componenti
      const sommaComponenti = spesaEnergia - scontoOfferta + spesaTrasporto + 
                              oneriSistema + altrePartite + imposte + iva;
      
      // Ottengo il totale della bolletta
      const totaleBolletta = parseFloat(document.getElementById('totaleBolletta').value) || 0;
      
      // Verifico se il totale della bolletta è stato inserito
      if (totaleBolletta <= 0) {
        alert("Inserisci l'importo totale della bolletta");
        return false;
      }
      
      // Verifico se la somma dei componenti è uguale al totale della bolletta
      const differenza = Math.abs(sommaComponenti - totaleBolletta);
      const verificaTotale = document.getElementById('verificaTotale');
      const btnCalcola = document.getElementById('btnCalcola');
      
      if (differenza > 0.01 && totaleBolletta > 0) {
        verificaTotale.style.display = 'block';
        verificaTotale.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> 
                                   Attenzione: La somma dei componenti (€ ${sommaComponenti.toFixed(2)}) 
                                   non corrisponde al totale della bolletta (€ ${totaleBolletta.toFixed(2)}).
                                   Differenza: € ${differenza.toFixed(2)}`;
        btnCalcola.disabled = true;
        return false;
      } else {
        verificaTotale.style.display = 'none';
        btnCalcola.disabled = false;
        return true;
      }
    }
    
    // Funzione per calcolare la ripartizione
    function calcola() {
      // Verifica che ci siano consumi
      if (consumoTotale <= 0) {
        alert("Non ci sono consumi da ripartire. Controlla le letture inserite.");
        return;
      }
      
      // Ottengo gli importi della bolletta
      const totaleBolletta = parseFloat(document.getElementById('totaleBolletta').value) || 0;
      const spesaEnergia = parseFloat(document.getElementById('spesaEnergia').value) || 0;
      const scontoOfferta = parseFloat(document.getElementById('scontoOfferta').value) || 0;
      const spesaTrasporto = parseFloat(document.getElementById('spesaTrasporto').value) || 0;
      const oneriSistema = parseFloat(document.getElementById('oneriSistema').value) || 0;
      const altrePartite = parseFloat(document.getElementById('altrePartite').value) || 0;
      const imposte = parseFloat(document.getElementById('imposte').value) || 0;
      const iva = parseFloat(document.getElementById('iva').value) || 0;
      
      // Calcolo le percentuali di consumo
      const percentualeApt1 = consumoApt1 / consumoTotale;
      const percentualeApt2 = consumoApt2 / consumoTotale;
      const percentualeApt3 = consumoApt3 / consumoTotale;
      
      // Calcolo gli importi per appartamento
      const importoApt1 = totaleBolletta * percentualeApt1;
      const importoApt2 = totaleBolletta * percentualeApt2;
      const importoApt3 = totaleBolletta * percentualeApt3;
      
      // Calcolo gli importi per componente e per appartamento
      const componenti = [
        { nome: 'Spesa per la Materia Energia', valore: spesaEnergia },
        { nome: 'Sconto Offerta', valore: -scontoOfferta },
        { nome: 'Spesa per il Trasporto', valore: spesaTrasporto },
        { nome: 'Oneri di Sistema', valore: oneriSistema },
        { nome: 'Altre Partite', valore: altrePartite },
        { nome: 'Imposte', valore: imposte },
        { nome: 'IVA', valore: iva }
      ];
      
      // Preparo i dati per la visualizzazione dei risultati
      const dataInizio = document.getElementById('dataPeriodoInizio').value;
      const dataFine = document.getElementById('dataPeriodoFine').value;
      
      // Aggiorno i risultati
      document.getElementById('periodoRiferimento').textContent = 
        `${formatDate(dataInizio)} - ${formatDate(dataFine)}`;
      document.getElementById('totaleRiepilogo').textContent = formatEuro(totaleBolletta);
      
      document.getElementById('consumoApt1Risultato').textContent = consumoApt1;
      document.getElementById('percentualeApt1').textContent = (percentualeApt1 * 100).toFixed(2) + '%';
      document.getElementById('pagareApt1').textContent = formatEuro(importoApt1);
      
      document.getElementById('consumoApt2Risultato').textContent = consumoApt2;
      document.getElementById('percentualeApt2').textContent = (percentualeApt2 * 100).toFixed(2) + '%';
      document.getElementById('pagareApt2').textContent = formatEuro(importoApt2);
      
      document.getElementById('consumoApt3Risultato').textContent = consumoApt3;
      document.getElementById('percentualeApt3').textContent = (percentualeApt3 * 100).toFixed(2) + '%';
      document.getElementById('pagareApt3').textContent = formatEuro(importoApt3);
      
      // Aggiorno la tabella dei componenti
      const dettaglioComponenti = document.getElementById('dettaglioComponenti');
      dettaglioComponenti.innerHTML = '';
      
      componenti.forEach(comp => {
        const compApt1 = comp.valore * percentualeApt1;
        const compApt2 = comp.valore * percentualeApt2;
        const compApt3 = comp.valore * percentualeApt3;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${comp.nome}</td>
          <td class="text-center">${formatEuro(comp.valore)}</td>
          <td class="text-center">${formatEuro(compApt1)}</td>
          <td class="text-center">${formatEuro(compApt2)}</td>
          <td class="text-center">${formatEuro(compApt3)}</td>
        `;
        dettaglioComponenti.appendChild(row);
      });
      
      // Aggiorno il totale complessivo
      document.getElementById('totaleComplessivo').textContent = formatEuro(totaleBolletta);
      document.getElementById('totaleApt1').textContent = formatEuro(importoApt1);
      document.getElementById('totaleApt2').textContent = formatEuro(importoApt2);
      document.getElementById('totaleApt3').textContent = formatEuro(importoApt3);
      
      // Mostro i risultati
      document.getElementById('noResults').style.display = 'none';
      document.getElementById('risultatoContainer').style.display = 'block';
      
      // Passo alla tab dei risultati
      const resultsTab = document.getElementById('results-tab');
      bootstrap.Tab.getInstance(resultsTab) || new bootstrap.Tab(resultsTab);
      resultsTab.click();
      
      // Salvo nella cronologia
      const nuovaRipartizione = {
        data: new Date().toISOString(),
        periodo: {
          inizio: dataInizio,
          fine: dataFine
        },
        consumi: {
          apt1: consumoApt1,
          apt2: consumoApt2,
          apt3: consumoApt3,
          totale: consumoTotale
        },
        importi: {
          apt1: importoApt1,
          apt2: importoApt2,
          apt3: importoApt3,
          totale: totaleBolletta
        },
        componenti: componenti
      };
      
      cronologia.unshift(nuovaRipartizione);
      localStorage.setItem('cronologia', JSON.stringify(cronologia));
      
      // Aggiorno la cronologia
      aggiornaStorico();
    }
    
    // Funzione per aggiornare la cronologia
    function aggiornaStorico() {
      const noCronologia = document.getElementById('noCronologia');
      const cronologiaContainer = document.getElementById('cronologiaContainer');
      const cronologiaBody = document.getElementById('cronologiaBody');
      
      if (cronologia.length === 0) {
        noCronologia.style.display = 'block';
        cronologiaContainer.style.display = 'none';
        return;
      }
      
      noCronologia.style.display = 'none';
      cronologiaContainer.style.display = 'block';
      
      cronologiaBody.innerHTML = '';
      
      cronologia.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${formatDate(item.data)}</td>
          <td>${formatDate(item.periodo.inizio)} - ${formatDate(item.periodo.fine)}</td>
          <td class="text-center">${formatEuro(item.importi.totale)}</td>
          <td class="text-center">${formatEuro(item.importi.apt1)}</td>
          <td class="text-center">${formatEuro(item.importi.apt2)}</td>
          <td class="text-center">${formatEuro(item.importi.apt3)}</td>
          <td class="text-center">
            <button class="btn btn-sm btn-danger delete-btn" data-index="${index}">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        cronologiaBody.appendChild(row);
      });
      
      // Aggiungo event listener per i pulsanti di eliminazione
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          eliminaRipartizione(index);
        });
      });
    }
    
    // Funzione per eliminare una ripartizione dalla cronologia
    function eliminaRipartizione(index) {
      if (confirm('Sei sicuro di voler eliminare questa ripartizione?')) {
        cronologia.splice(index, 1);
        localStorage.setItem('cronologia', JSON.stringify(cronologia));
        aggiornaStorico();
      }
    }
    
    // Funzione per svuotare la cronologia
    function svuotaCronologia() {
      if (confirm('Sei sicuro di voler eliminare tutte le ripartizioni dalla cronologia?')) {
        cronologia = [];
        localStorage.setItem('cronologia', JSON.stringify(cronologia));
        aggiornaStorico();
      }
    }
    
    // Funzione per stampare i risultati
    function stampaRisultati() {
      window.print();
    }
    
    // Event listeners
    document.getElementById('btnCalcolaConsumi').addEventListener('click', calcolaConsumi);
    document.getElementById('btnVerificaComponenti').addEventListener('click', verificaComponenti);
    document.getElementById('btnCalcola').addEventListener('click', calcola);
    document.getElementById('btnStampaRisultati').addEventListener('click', stampaRisultati);
    document.getElementById('btnSvuotaCronologia').addEventListener('click', svuotaCronologia);
    
    // Inizializzazione
    window.addEventListener('load', function() {
      aggiornaStorico();
      
      // Mostra i risultati se ci sono
      if (cronologia.length > 0) {
        document.getElementById('noResults').style.display = 'none';
        document.getElementById('risultatoContainer').style.display = 'block';
      }
    });
  </script>
</body>
</html>
