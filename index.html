<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ripartizione Bolletta Elettrica Condominiale</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        h2 {
            color: #3498db;
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"], input[type="text"], input[type="date"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .result {
            margin-top: 20px;
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            border-left: 5px solid #3498db;
        }
        .error {
            color: red;
            font-size: 14px;
            margin-top: 5px;
        }
        .tab-container {
            margin-top: 20px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f2f2f2;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
        }
        .tab-content.active {
            display: block;
        }
        .flex-container {
            display: flex;
            gap: 15px;
        }
        .flex-container > div {
            flex: 1;
        }
        @media (max-width: 768px) {
            .flex-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ripartizione Bolletta Elettrica Condominiale</h1>
        
        <div class="tab-container">
            <div class="tabs">
                <div class="tab active" id="tab-letture">Letture Contatori</div>
                <div class="tab" id="tab-bolletta">Dati Bolletta</div>
                <div class="tab" id="tab-risultati">Risultati</div>
                <div class="tab" id="tab-storico">Storico</div>
            </div>
            
            <div id="dati-letture" class="tab-content active">
                <h2>Inserimento Letture Contatori</h2>
                
                <div class="form-group">
                    <label for="data-lettura">Data Lettura:</label>
                    <input type="date" id="data-lettura" required>
                </div>
                
                <div class="flex-container">
                    <div>
                        <h3>Appartamento 1</h3>
                        <div class="form-group">
                            <label for="lettura-app1">Lettura Contascatti:</label>
                            <input type="number" id="lettura-app1" min="0" step="1" required>
                        </div>
                    </div>
                    
                    <div>
                        <h3>Appartamento 2</h3>
                        <div class="form-group">
                            <label for="lettura-app2">Lettura Contascatti:</label>
                            <input type="number" id="lettura-app2" min="0" step="1" required>
                        </div>
                    </div>
                    
                    <div>
                        <h3>Appartamento 3</h3>
                        <div class="form-group">
                            <label for="lettura-app3">Lettura Contascatti:</label>
                            <input type="number" id="lettura-app3" min="0" step="1" required>
                        </div>
                    </div>
                </div>
                
                <button id="salva-letture">Salva Letture</button>
                
                <div id="letture-error" class="error"></div>
                
                <h3>Letture Salvate</h3>
                <table id="tabella-letture">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Appartamento 1</th>
                            <th>Appartamento 2</th>
                            <th>Appartamento 3</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-letture">
                        <!-- Le letture verranno inserite qui via JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div id="dati-bolletta" class="tab-content">
                <h2>Inserimento Dati Bolletta</h2>
                
                <div class="form-group">
                    <label for="periodo-bolletta">Periodo Bolletta:</label>
                    <div class="flex-container">
                        <div>
                            <label for="data-inizio">Data Inizio:</label>
                            <input type="date" id="data-inizio" required>
                        </div>
                        <div>
                            <label for="data-fine">Data Fine:</label>
                            <input type="date" id="data-fine" required>
                        </div>
                    </div>
                </div>
                
                <h3>Dati di Consumo</h3>
                <div class="form-group">
                    <label for="kwh-totali">KWh Totali:</label>
                    <input type="number" id="kwh-totali" min="0" step="0.01" required>
                </div>
                
                <h3>Componenti Bolletta</h3>
                <div class="form-group">
                    <label for="spesa-energia">Spesa per la Materia Energia (€):</label>
                    <input type="number" id="spesa-energia" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="sconto-offerta">Sconto Offerta se Previsto (€):</label>
                    <input type="number" id="sconto-offerta" step="0.01" value="0">
                </div>
                
                <div class="form-group">
                    <label for="spesa-trasporto">Spesa per il Trasporto (€):</label>
                    <input type="number" id="spesa-trasporto" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="oneri-sistema">Spesa per Oneri di Sistema (€):</label>
                    <input type="number" id="oneri-sistema" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="altre-partite">Altre Partite (€):</label>
                    <input type="number" id="altre-partite" step="0.01" value="0">
                </div>
                
                <div class="form-group">
                    <label for="imposte">Imposte (€):</label>
                    <input type="number" id="imposte" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="iva">IVA (€):</label>
                    <input type="number" id="iva" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="totale-bolletta">Totale Bolletta (€):</label>
                    <input type="number" id="totale-bolletta" min="0" step="0.01" required>
                </div>
                
                <button id="salva-bolletta">Salva Bolletta</button>
                
                <div id="bolletta-error" class="error"></div>
                
                <h3>Bollette Salvate</h3>
                <table id="tabella-bollette">
                    <thead>
                        <tr>
                            <th>Periodo</th>
                            <th>KWh Totali</th>
                            <th>Totale (€)</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-bollette">
                        <!-- Le bollette verranno inserite qui via JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div id="risultati" class="tab-content">
                <h2>Risultati Ripartizione</h2>
                
                <div class="form-group">
                    <label for="seleziona-bolletta">Seleziona Bolletta:</label>
                    <select id="seleziona-bolletta">
                        <option value="">-- Seleziona una bolletta --</option>
                    </select>
                </div>
                
                <button id="calcola-ripartizione">Calcola Ripartizione</button>
                
                <div id="risultati-container" class="result" style="display:none;">
                    <h3>Ripartizione per Appartamento</h3>
                    
                    <table id="tabella-risultati">
                        <thead>
                            <tr>
                                <th>Appartamento</th>
                                <th>Consumo (scatti)</th>
                                <th>% sul Totale</th>
                                <th>Importo da Pagare (€)</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-risultati">
                            <!-- I risultati verranno inseriti qui via JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <th>Totale</th>
                                <th id="totale-scatti"></th>
                                <th>100%</th>
                                <th id="totale-importo"></th>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <h3>Dettaglio Ripartizione Componenti</h3>
                    <table id="tabella-dettaglio">
                        <thead>
                            <tr>
                                <th>Componente</th>
                                <th>App. 1 (€)</th>
                                <th>App. 2 (€)</th>
                                <th>App. 3 (€)</th>
                                <th>Totale (€)</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-dettaglio">
                            <!-- I dettagli verranno inseriti qui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="storico" class="tab-content">
                <h2>Storico Ripartizioni</h2>
                
                <table id="tabella-storico">
                    <thead>
                        <tr>
                            <th>Periodo</th>
                            <th>App. 1 (€)</th>
                            <th>App. 2 (€)</th>
                            <th>App. 3 (€)</th>
                            <th>Totale (€)</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-storico">
                        <!-- Lo storico verrà inserito qui via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Inizializzazione storage
        if (!localStorage.getItem('letture')) {
            localStorage.setItem('letture', JSON.stringify([]));
        }
        if (!localStorage.getItem('bollette')) {
            localStorage.setItem('bollette', JSON.stringify([]));
        }
        if (!localStorage.getItem('ripartizioni')) {
            localStorage.setItem('ripartizioni', JSON.stringify([]));
        }
        
        // Gestione tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Rimuovi la classe active da tutti i tab e contenuti
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Aggiungi la classe active al tab selezionato
                this.classList.add('active');
                
                // Determina quale contenuto mostrare in base all'id del tab
                let contentId;
                if (this.id === 'tab-letture') contentId = 'dati-letture';
                else if (this.id === 'tab-bolletta') contentId = 'dati-bolletta';
                else if (this.id === 'tab-risultati') {
                    contentId = 'risultati';
                    aggiornaSelezioneBollette();
                }
                else if (this.id === 'tab-storico') {
                    contentId = 'storico';
                    aggiornaStorico();
                }
                
                // Mostra il contenuto corrispondente
                document.getElementById(contentId).classList.add('active');
            });
        });
        
        // Formatta data in italiano
        function formattaData(dataStr) {
            const data = new Date(dataStr);
            return data.toLocaleDateString('it-IT');
        }
        
        // Funzione per salvare le letture
        function salvaLetture() {
            const dataLettura = document.getElementById('data-lettura').value;
            const letturaApp1 = parseInt(document.getElementById('lettura-app1').value);
            const letturaApp2 = parseInt(document.getElementById('lettura-app2').value);
            const letturaApp3 = parseInt(document.getElementById('lettura-app3').value);
            
            if (!dataLettura || isNaN(letturaApp1) || isNaN(letturaApp2) || isNaN(letturaApp3)) {
                document.getElementById('letture-error').textContent = 'Tutti i campi sono obbligatori';
                return;
            }
            
            const letture = JSON.parse(localStorage.getItem('letture'));
            
            // Controllo se esiste già una lettura per questa data
            const esistente = letture.findIndex(l => l.data === dataLettura);
            if (esistente >= 0) {
                letture[esistente] = {
                    data: dataLettura,
                    appartamento1: letturaApp1,
                    appartamento2: letturaApp2,
                    appartamento3: letturaApp3
                };
            } else {
                letture.push({
                    data: dataLettura,
                    appartamento1: letturaApp1,
                    appartamento2: letturaApp2,
                    appartamento3: letturaApp3
                });
            }
            
            // Ordina per data
            letture.sort((a, b) => new Date(a.data) - new Date(b.data));
            
            localStorage.setItem('letture', JSON.stringify(letture));
            document.getElementById('letture-error').textContent = '';
            
            // Reset form
            document.getElementById('data-lettura').value = '';
            document.getElementById('lettura-app1').value = '';
            document.getElementById('lettura-app2').value = '';
            document.getElementById('lettura-app3').value = '';
            
            aggiornaTabellaLetture();
        }
        
        // Associa la funzione al pulsante
        document.getElementById('salva-letture').addEventListener('click', salvaLetture);
        
        // Aggiorna tabella letture
        function aggiornaTabellaLetture() {
            const letture = JSON.parse(localStorage.getItem('letture'));
            const tbody = document.getElementById('tbody-letture');
            tbody.innerHTML = '';
            
            letture.forEach((lettura, index) => {
                const row = document.createElement('tr');
                
                const dataCell = document.createElement('td');
                dataCell.textContent = formattaData(lettura.data);
                row.appendChild(dataCell);
                
                const app1Cell = document.createElement('td');
                app1Cell.textContent = lettura.appartamento1;
                row.appendChild(app1Cell);
                
                const app2Cell = document.createElement('td');
                app2Cell.textContent = lettura.appartamento2;
                row.appendChild(app2Cell);
                
                const app3Cell = document.createElement('td');
                app3Cell.textContent = lettura.appartamento3;
                row.appendChild(app3Cell);
                
                const actionCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Elimina';
                deleteBtn.style.backgroundColor = '#e74c3c';
                deleteBtn.addEventListener('click', function() {
                    eliminaLettura(index);
                });
                actionCell.appendChild(deleteBtn);
                row.appendChild(actionCell);
                
                tbody.appendChild(row);
            });
        }
        
        // Elimina lettura
        function eliminaLettura(index) {
            if (confirm('Sei sicuro di voler eliminare questa lettura?')) {
                const letture = JSON.parse(localStorage.getItem('letture'));
                letture.splice(index, 1);
                localStorage.setItem('letture', JSON.stringify(letture));
                aggiornaTabellaLetture();
            }
        }
        
        // Funzione per salvare la bolletta
        function salvaBolletta() {
            const dataInizio = document.getElementById('data-inizio').value;
            const dataFine = document.getElementById('data-fine').value;
            const kwhTotali = parseFloat(document.getElementById('kwh-totali').value);
            const spesaEnergia = parseFloat(document.getElementById('spesa-energia').value);
            const scontoOfferta = parseFloat(document.getElementById('sconto-offerta').value) || 0;
            const spesaTrasporto = parseFloat(document.getElementById('spesa-trasporto').value);
            const oneriSistema = parseFloat(document.getElementById('oneri-sistema').value);
            const altrePartite = parseFloat(document.getElementById('altre-partite').value) || 0;
            const imposte = parseFloat(document.getElementById('imposte').value);
            const iva = parseFloat(document.getElementById('iva').value);
            const totaleBolletta = parseFloat(document.getElementById('totale-bolletta').value);
            
            if (!dataInizio || !dataFine || isNaN(kwhTotali) || isNaN(spesaEnergia) || 
                isNaN(spesaTrasporto) || isNaN(oneriSistema) || isNaN(imposte) || 
                isNaN(iva) || isNaN(totaleBolletta)) {
                document.getElementById('bolletta-error').textContent = 'Tutti i campi obbligatori devono essere compilati';
                return;
            }
            
            // Controllo se abbiamo letture per questo periodo
            const letture = JSON.parse(localStorage.getItem('letture'));
            const lettureNelPeriodo = letture.filter(l => l.data >= dataInizio && l.data <= dataFine);
            
            if (lettureNelPeriodo.length < 2) {
                document.getElementById('bolletta-error').textContent = 'Sono necessarie almeno due letture nel periodo della bolletta';
                return;
            }
            
            const bolletta = {
                id: Date.now().toString(),
                dataInizio,
                dataFine,
                kwhTotali,
                spesaEnergia,
                scontoOfferta,
                spesaTrasporto,
                oneriSistema,
                altrePartite,
                imposte,
                iva,
                totaleBolletta
            };
            
            const bollette = JSON.parse(localStorage.getItem('bollette'));
            bollette.push(bolletta);
            localStorage.setItem('bollette', JSON.stringify(bollette));
            
            // Reset form
            document.getElementById('data-inizio').value = '';
            document.getElementById('data-fine').value = '';
            document.getElementById('kwh-totali').value = '';
            document.getElementById('spesa-energia').value = '';
            document.getElementById('sconto-offerta').value = '0';
            document.getElementById('spesa-trasporto').value = '';
            document.getElementById('oneri-sistema').value = '';
            document.getElementById('altre-partite').value = '0';
            document.getElementById('imposte').value = '';
            document.getElementById('iva').value = '';
            document.getElementById('totale-bolletta').value = '';
            document.getElementById('bolletta-error').textContent = '';
            
            aggiornaTabellaBollette();
            aggiornaSelezioneBollette();
        }
        
        // Associa la funzione al pulsante
        document.getElementById('salva-bolletta').addEventListener('click', salvaBolletta);
        
        // Aggiorna tabella bollette
        function aggiornaTabellaBollette() {
            const bollette = JSON.parse(localStorage.getItem('bollette'));
            const tbody = document.getElementById('tbody-bollette');
            tbody.innerHTML = '';
            
            bollette.forEach((bolletta, index) => {
                const row = document.createElement('tr');
                
                const periodoCell = document.createElement('td');
                periodoCell.textContent = `${formattaData(bolletta.dataInizio)} - ${formattaData(bolletta.dataFine)}`;
                row.appendChild(periodoCell);
                
                const kwhCell = document.createElement('td');
                kwhCell.textContent = bolletta.kwhTotali.toFixed(2);
                row.appendChild(kwhCell);
                
                const totaleCell = document.createElement('td');
                totaleCell.textContent = bolletta.totaleBolletta.toFixed(2) + ' €';
                row.appendChild(totaleCell);
                
                const actionCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Elimina';
                deleteBtn.style.backgroundColor = '#e74c3c';
                deleteBtn.addEventListener('click', function() {
                    eliminaBolletta(index);
                });
                actionCell.appendChild(deleteBtn);
                row.appendChild(actionCell);
                
                tbody.appendChild(row);
            });
        }
        
        // Elimina bolletta
        function eliminaBolletta(index) {
            if (confirm('Sei sicuro di voler eliminare questa bolletta?')) {
                const bollette = JSON.parse(localStorage.getItem('bollette'));
                const bollettaId = bollette[index].id;
                
                // Rimuovi la bolletta
                bollette.splice(index, 1);
                localStorage.setItem('bollette', JSON.stringify(bollette));
                
                // Rimuovi anche la ripartizione associata
                const ripartizioni = JSON.parse(localStorage.getItem('ripartizioni'));
                const nuoveRipartizioni = ripartizioni.filter(r => r.bollettaId !== bollettaId);
                localStorage.setItem('ripartizioni', JSON.stringify(nuoveRipartizioni));
                
                aggiornaTabellaBollette();
                aggiornaSelezioneBollette();
                aggiornaStorico();
            }
        }
        
        // Aggiorna selezione bollette
        function aggiornaSelezioneBollette() {
            const bollette = JSON.parse(localStorage.getItem('bollette'));
            const select = document.getElementById('seleziona-bolletta');
            
            // Mantieni solo la prima opzione
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            bollette.forEach((bolletta) => {
                const option = document.createElement('option');
                option.value = bolletta.id;
                option.textContent = `${formattaData(bolletta.dataInizio)} - ${formattaData(bolletta.dataFine)} (${bolletta.totaleBolletta.toFixed(2)} €)`;
                select.appendChild(option);
            });
        }
        
        // Calcola ripartizione
        function calcolaRipartizione() {
            const bollettaId = document.getElementById('seleziona-bolletta').value;
            if (!bollettaId) {
                alert('Seleziona una bolletta per calcolare la ripartizione');
                return;
            }
            
            const bollette = JSON.parse(localStorage.getItem('bollette'));
            const bolletta = bollette.find(b => b.id === bollettaId);
            
            if (!bolletta) {
                alert('Bolletta non trovata');
                return;
            }
            
            const letture = JSON.parse(localStorage.getItem('letture'));
            
            // Filtra e ordina le letture nel periodo
            const letturePeriodo = letture
                .filter(l => l.data >= bolletta.dataInizio && l.data <= bolletta.dataFine)
                .sort((a, b) => new Date(a.data) - new Date(b.data));
            
            if (letturePeriodo.length < 2) {
                alert('Sono necessarie almeno due letture nel periodo della bolletta');
                return;
            }
            
            // Prendi la prima e ultima lettura nel periodo
            const letturaIniziale = letturePeriodo[0];
            const letturaFinale = letturePeriodo[letturePeriodo.length - 1];
            
            // Calcola consumo per ogni appartamento
            const consumoApp1 = letturaFinale.appartamento1 - letturaIniziale.appartamento1;
            const consumoApp2 = letturaFinale.appartamento2 - letturaIniziale.appartamento2;
            const consumoApp3 = letturaFinale.appartamento3 - letturaIniziale.appartamento3;
            const consumoTotale = consumoApp1 + consumoApp2 + consumoApp3;
            
            // Calcola percentuali
            const percentualeApp1 = consumoTotale > 0 ? consumoApp1 / consumoTotale : 0;
            const percentualeApp2 = consumoTotale > 0 ? consumoApp2 / consumoTotale : 0;
            const percentualeApp3 = consumoTotale > 0 ? consumoApp3 / consumoTotale : 0;
            
            // Calcola importi per componente
            const componenti = [
                { nome: 'Spesa per la Materia Energia', valore: bolletta.spesaEnergia },
                { nome: 'Sconto Offerta', valore: bolletta.scontoOfferta },
                { nome: 'Spesa per il Trasporto', valore: bolletta.spesaTrasporto },
                { nome: 'Oneri di Sistema', valore: bolletta.oneriSistema },
                { nome: 'Altre Partite', valore: bolletta.altrePartite },
                { nome: 'Imposte', valore: bolletta.imposte },
                { nome: 'IVA', valore: bolletta.iva }
            ];
            
            const dettaglio = componenti.map(comp => {
                const app1 = comp.valore * percentualeApp1;
                const app2 = comp.valore * percentualeApp2;
                const app3 = comp.valore * percentualeApp3;
                return {
                    nome: comp.nome,
                    app1,
                    app2,
                    app3,
                    totale: comp.valore
                };
            });
            
            // Calcola totali per appartamento
            const totaleApp1 = dettaglio.reduce((sum, comp) => sum + comp.app1, 0);
            const totaleApp2 = dettaglio.reduce((sum, comp) => sum + comp.app2, 0);
            const totaleApp3 = dettaglio.reduce((sum, comp) => sum + comp.app3, 0);
            
            // Visualizza risultati
            mostraRisultati({
                consumoApp1,
                consumoApp2,
                consumoApp3,
                consumoTotale,
                percentualeApp1,
                percentualeApp2,
                percentualeApp3,
                totaleApp1,
                totaleApp2,
                totaleApp3,
                totaleBolletta: bolletta.totaleBolletta,
                dettaglio
            });
            
            // Salva ripartizione nello storico
            salvaRipartizione({
                bollettaI
